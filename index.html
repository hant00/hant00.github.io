<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>BWRAO Fantasy Leagues Standing</title>
    <meta http-Equiv="Cache-Control" Content="no-cache">
    <meta http-Equiv="Pragma" Content="no-cache">
    <meta http-Equiv="Expires" Content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <style type="text/css">
    
    p {
      font-size: 16px;
    }
    
    .standings_table {
      background-color: #ddd;
      margin: 10px;
    }

    .standings_table tr.odd {
      background-color: #eee;
    }

    .standings_table th, .standings_table td {
      padding: 5px;
    }

    .standings_table th {
      background-color: #fff;
      border-bottom: 1px solid #333;
      text-align: left;
    }

    a {
      color: #b04141;
      font-weight: bold;
      text-decoration: none;
    }
    </style>
  </head>
  <body>
    <br/>
    <p class="col-sm-7">
      Fantasy league standing table, merged from 
      <a href="https://www.fantasyseriea.com/en/league-standings/BWRAO/733">"BWRAO"</a> and 
      <a href="https://www.fantasyseriea.com/en/league-standings/BWRAO-League-2/1072">"BWRAO League 2"</a> leagues.
      It may take a while to retrieve & process data and fully load the table.
    </p>
    <p class="col-sm-7">
      This is just for fun, open project. Contributions* are welcome 
      <a href="https://github.com/hant00/hant00.github.io">here</a>.
    </p>
    <p class="col-sm-7">*) Code, that is. I ain't asking for no monies LOL</p>
    <!--<input type="checkbox" onchange="toggle" id="toggler" /><label for="toggler">Autorefresh (1min)</label>-->
    <table class="standings_table col-sm-7" cellspacing="" cellpadding="5">
      <tbody>
        <tr>
          <th style="width:2.6%;">&nbsp;</th>
          <th style="width:3.1%;">#</th>
          <th style="width:29%;">Team</th>
          <th style="width:29%;">Manager</th>
          <th style="width:5.8%;">C</th>
          <th style="width:9.8%;">Total</th>
          <th style="width:9.8%;">Round</th>
        </tr>
        <tr class="preloader">
          <td colspan="7" align="center">
            <img src="loading.io-blocks.gif" />
          </td>
        </tr>
      </tbody>
    </table>
    <script type="text/javascript">
      function retrieveLeague(lid) {
        return $.get('https://cors.io/?https://www.fantasyseriea.com/api/classic_table.php?lid=' + lid);
      }
      
      var leagueData = [];
      function onLeaguesRetrieved() {
        let teamset = [];
        let scoreset = [];
        for (var i = 0; i < leagueData.length; i++) {
          let first = i === 0;
          let parsed = $.parseHTML(leagueData[i]);
          let theTable = $(parsed[9]);
          let pos = 0;
          theTable.find('tr').each(function() {
            //skip header row
            if (this.children[1].tagName === 'TH') return true;
            let theTeam = $(this.children[2]).find('a').prop('href');
            let theScore = parseInt(this.children[6].innerText);
            if (first) {
              $(this).insertAfter($($('table').find('tr')[pos]));
              pos++;
            } else {
              //skip if already in displayed table
              if (teamset.indexOf(theTeam) !== -1) return true;
              pos = 0;
              while (pos < scoreset.length) {
                if (theScore > scoreset[pos])
                  break;
                pos++;
              }
              //insert
              $(this).insertAfter($($('table').find('tr')[pos]));
            }
            //add to sets
            teamset.push(theTeam);
            scoreset.push(theScore);
          });
        }
        
        //update rank & tr class
        let rank = 1;
        $('table tr').each(function () {
          if ($(this).hasClass('preloader') || this.children[1].tagName === 'TH')
            return true;
          this.children[1].innerText = rank;
          $(this).removeClass('odd');
          if (rank % 2 === 1)
            $(this).addClass('odd');
          rank++;
        });
        
        //TODO: cannot track position movement between rounds.
        //      well, it can be done, by calling data of each team's history.
        //      but that's just too much work for now lol.
        //      so remove up/down column for the moment
        $('table tr').find('th:first').remove();
        $('table tr').find('td:first').remove();
        //TODO: pagination
        
        //all done, remove preloader
        $('.preloader').remove();
      }
      
      //var leagues = [ 733, 1072 ];
      $(function ($) {
        retrieveLeague(733).done(function (data) {
          leagueData.push(data);
          retrieveLeague(1072).done(function (data) {
            leagueData.push(data);
            onLeaguesRetrieved();
          });
        });
      });
    </script>
  </body>
</html>
