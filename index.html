
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-Equiv="Cache-Control" Content="no-cache">
    <meta http-Equiv="Pragma" Content="no-cache">
    <meta http-Equiv="Expires" Content="0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <style type="text/css">
    .standings_table{
      background-color:#ddd;
      font-size:13px;
      width:50%;
    }

    .standings_table tr.odd{
      background-color:#eee;
    }

    .standings_table th{
      background-color:#fff;
      border-bottom:1px solid #333;
      text-align:left;
    }

    a{
      color:#b04141;
      font-weight:bold;
      text-decoration:none;
    }

    #below_tbl{
      border-top:1px solid black;
      width:100%;
      font-size:13px;
    }
    </style>
  </head>
  <body>
    <table class="standings_table" cellspacing="0" cellpadding="5">
      <tbody>
        <tr>
          <th style="width:2.6%;">&nbsp;</th>
          <th style="width:3.1%;">#</th>
          <th style="width:29%;">Team</th>
          <th style="width:29%;">Manager</th>
          <th style="width:5.8%;">C</th>
          <th style="width:9.8%;">Total</th>
          <th style="width:9.8%;">Round</th>
        </tr>
        <tr class="preloader">
          <th colspan="7" align="center">
            <img src="loading.io-blocks.gif" />
          </th>
        </tr>
      </tbody>
    </table>
    <script type="text/javascript">
      function retrieveLeague(lid) {
        return $.get('https://cors.io/?https://www.fantasyseriea.com/api/classic_table.php?lid=' + lid);
      }
      
      var leagueData = [];
      function onLeaguesRetrieved() {
        let teamset = [];
        let scoreset = [];
        for (var i = 0; i < leagueData.length; i++) {
          let first = i === 0;
          let parsed = $.parseHTML(leagueData[i]);
          let theTable = $(parsed[9]);
          let pos = 0;
          theTable.find('tr').each(function() {
            //skip header row
            if (this.firstChild.tagName === 'TH') return true;
            let theTeam = $(this.children[2]).find('a').prop('href');
            let theScore = parseInt(this.children[6].innerText);
            if (first) {
              $(this).insertAfter($($('table').find('tr')[pos]));
              pos++;
            } else {
              pos = 0;
              while (pos < scoreset.length) {
                if (theScore > scoreset[pos])
                  break;
                pos++;
              }
              //insert
              $(this).insertAfter($($('table').find('tr')[pos]));
            }
            //add to sets
            teamset.push(theTeam);
            scoreset.push(theScore);
          });
        }
        
        //update rank & tr class
        let rank = 1;
        $('table tr').each(function () {
          if (this.firstChild.tagName === 'TH') return true;
          this.children[1].innerText = rank;
          $(this).removeClass('odd');
          if (rank % 2 === 1)
            $(this).addClass('odd');
          rank++;
        });
        
        //TODO: cannot track position movement between rounds.
        //      well, it can be done, by calling data of each team's history.
        //      but that's just too much work for now lol.
        //      so remove up/down column for the moment
        $('table tr').find('th:first').remove();
        $('table tr').find('td:first').remove();
        //TODO: pagination
        
        //all done, remove preloader
        $('.preloader').remove();
      }
      
      //var leagues = [ 733, 1072 ];
      $(function ($) {
        retrieveLeague(733).done(function (data) {
          leagueData.push(data);
          retrieveLeague(1072).done(function (data) {
            leagueData.push(data);
            onLeaguesRetrieved();
          });
        });
      });
    </script>
  </body>
</html>
